<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cool City 半RP服务器</title>
    <script src="vendor/tailwind.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0A2463',
                        dark: '#121212',
                        light: '#f8f9fa'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .bg-blur {
                backdrop-filter: blur(8px);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
        }
        
        body {
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .max-w-2xl {
            max-width: 700px;
        }
        
        .px-6 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .px-8 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
    </style>
</head>
<body class="bg-dark text-light min-h-screen flex flex-col">
    <!-- 背景图 (后续可替换) -->
    <div class="fixed inset-0 z-0">
        <div class="absolute inset-0 bg-gradient-to-b from-dark via-dark/90 to-dark"></div>
    </div>

    <main class="flex-grow relative z-10 py-12 px-6 md:px-12 max-w-4xl mx-auto w-full flex items-center">
        <div class="w-full">
            <div class="text-center mb-10">
                <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold mb-4 text-shadow text-primary">Cool City 半RP服务器</h1>
                <p class="text-white/70 text-lg">角色扮演生活服</p>
            </div>

            <div class="bg-dark/60 bg-blur rounded-2xl overflow-hidden border border-white/10 max-w-2xl mx-auto">
                <div class="flex justify-center p-8">
                    <div class="w-32 h-32 rounded-full overflow-hidden border-4 border-primary/30 shadow-lg shadow-primary/20">
                        <img src="assets/server-icon.png" alt="服务器图标" class="w-full h-full object-cover">
                    </div>
                </div>

                <div class="px-8 pb-8">
                    <h2 class="text-2xl font-bold text-white text-center mb-4">Cool City 半RP服务器</h2>
                    <p class="text-white/70 text-center mb-8">
                        体验最真实的城市生活，拥有完整的经济系统和职业体系，与其他玩家共同打造属于你们的故事。
                        自定义内容丰富，游戏体验流畅，欢迎加入我们的社区！
                    </p>
                    
                    <div class="flex justify-center">
                        <button id="join-button" class="bg-primary hover:bg-primary/90 text-white px-10 py-4 rounded-xl font-bold text-lg transition-all duration-300 flex items-center shadow-xl shadow-primary/30 transform hover:scale-105">
                            <i class="fa fa-play-circle mr-3"></i>加入服务器
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 协议确认提示遮罩 -->
    <div id="protocol-prompt" class="fixed inset-0 z-50 bg-dark/80 flex items-center justify-center hidden">
        <div class="bg-dark/90 bg-blur border border-primary/30 rounded-xl p-8 max-w-md w-full mx-4 transform transition-all">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-gamepad text-primary text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white">启动FiveM游戏</h3>
                <p class="text-white/60 mt-2">点击下方按钮后，系统可能会要求确认协议处理程序，请选择"始终允许"以避免重复提示</p>
            </div>
            <div class="space-y-4">
                <button id="confirm-launch" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center shadow-lg shadow-primary/20">
                    <i class="fa fa-play-circle mr-2"></i>直接启动
                </button>
                <button id="cancel-launch" class="w-full bg-dark/80 hover:bg-dark/60 text-white/70 py-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center border border-white/10">
                    <i class="fa fa-times mr-2"></i>取消
                </button>
                <p class="text-white/40 text-xs text-center">首次启动可能需要系统确认协议处理程序</p>
            </div>
        </div>
    </div>

    <!-- 配置FiveM路径对话框 -->
    <div id="path-config" class="fixed inset-0 z-50 bg-dark/80 flex items-center justify-center hidden">
        <div class="bg-dark/90 bg-blur border border-primary/30 rounded-xl p-8 max-w-md w-full mx-4 transform transition-all">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-cog text-primary text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-white">配置FiveM路径</h3>
                <p class="text-white/60 mt-2">输入FiveM可执行文件路径以避免协议确认</p>
            </div>
            <div class="space-y-4">
                <div class="flex">
                    <input id="fivem-path" type="text" placeholder="例如: C:\Program Files\FiveM\FiveM.exe" class="flex-grow bg-dark/80 border border-white/10 rounded-l-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="browse-path" class="bg-primary/20 hover:bg-primary/30 text-white px-4 py-3 rounded-r-lg transition-all duration-300">
                        <i class="fa fa-folder-open"></i>
                    </button>
                </div>
                <button id="save-path" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center shadow-lg shadow-primary/20">
                    <i class="fa fa-save mr-2"></i>保存配置
                </button>
                <button id="cancel-path" class="w-full bg-dark/80 hover:bg-dark/60 text-white/70 py-3 rounded-lg font-medium transition-all duration-300 flex items-center justify-center border border-white/10">
                    <i class="fa fa-times mr-2"></i>取消
                </button>
            </div>
        </div>
    </div>

    <script>
        // 服务器ID
        const SERVER_ID = 'me8g8d';
        const PROTOCOL_URL = `fivem://connect/${SERVER_ID}`;
        
        // 获取DOM元素
        const joinButton = document.getElementById('join-button');
        const protocolPrompt = document.getElementById('protocol-prompt');
        const confirmLaunch = document.getElementById('confirm-launch');
        const cancelLaunch = document.getElementById('cancel-launch');
        const pathConfig = document.getElementById('path-config');
        const fivemPathInput = document.getElementById('fivem-path');
        const browsePathButton = document.getElementById('browse-path');
        const savePathButton = document.getElementById('save-path');
        const cancelPathButton = document.getElementById('cancel-path');
        
        // 检查环境和配置
        const isPakeApp = typeof window.pake !== 'undefined';
        const isProtocolConfirmed = localStorage.getItem('fivemProtocolConfirmed') === 'true';
        const fivemPath = localStorage.getItem('fivemPath');

        // 显示协议确认框
        joinButton.addEventListener('click', () => {
            // 如果已配置路径且在Pake环境中，直接启动
            if (fivemPath && isPakeApp) {
                try {
                    joinButton.disabled = true;
                    joinButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-3"></i>正在启动...';
                    
                    // 直接通过路径启动FiveM
                    window.pake.api.exec(fivemPath, ['+connect', SERVER_ID])
                        .then(() => {
                            console.log('通过路径启动FiveM成功');
                            setTimeout(() => {
                                joinButton.disabled = false;
                                joinButton.innerHTML = '<i class="fa fa-play-circle mr-3"></i>加入服务器';
                            }, 2000);
                        })
                        .catch(error => {
                            handleLaunchError(error, '通过路径启动失败');
                        });
                } catch (error) {
                    handleLaunchError(error, '启动过程出错');
                }
            } else {
                // 未配置路径，显示协议确认框
                protocolPrompt.classList.remove('hidden');
            }
        });

        // 确认启动游戏
        confirmLaunch.addEventListener('click', () => {
            try {
                protocolPrompt.classList.add('hidden');
                joinButton.disabled = true;
                joinButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-3"></i>正在启动...';
                
                // 尝试注册协议处理程序（如果支持）
                if (isPakeApp && !isProtocolConfirmed) {
                    try {
                        window.pake.api.registerProtocolHandler('fivem', 'coolcity-launcher')
                            .then(() => {
                                console.log('协议处理程序注册成功');
                                localStorage.setItem('fivemProtocolConfirmed', 'true');
                            })
                            .catch(err => console.log('协议注册失败', err));
                    } catch (e) {
                        console.log('协议注册API不可用');
                    }
                }
                
                // 使用原生API启动FiveM
                if (isPakeApp) {
                    window.pake.api.openExternal(PROTOCOL_URL).then(() => {
                        console.log('通过Pake原生API启动FiveM');
                    }).catch(error => {
                        handleLaunchError(error, 'Pake原生API启动失败');
                    });
                } else {
                    // 非Pake环境（备用方案）
                    fallbackLaunch();
                }
                
                // 3秒后重置按钮状态
                setTimeout(() => {
                    joinButton.disabled = false;
                    joinButton.innerHTML = '<i class="fa fa-play-circle mr-3"></i>加入服务器';
                    
                    // 如果是首次启动且在Pake环境中，提示配置路径
                    if (isPakeApp && !fivemPath) {
                        setTimeout(() => {
                            showPathConfig();
                        }, 1000);
                    }
                }, 3000);
                
            } catch (error) {
                handleLaunchError(error, '启动过程出错');
            }
        });
        
        // PakePlus环境外的备用启动方案
        function fallbackLaunch() {
            try {
                const a = document.createElement('a');
                a.href = PROTOCOL_URL;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                handleLaunchError(error, '备用方案启动失败');
            }
        }
        
        // 显示路径配置对话框
        function showPathConfig() {
            // 填充已保存的路径（如果有）
            if (fivemPath) {
                fivemPathInput.value = fivemPath;
            }
            pathConfig.classList.remove('hidden');
        }
        
        // 浏览文件选择对话框
        browsePathButton.addEventListener('click', () => {
            if (isPakeApp) {
                window.pake.api.openFileDialog({
                    title: '选择FiveM可执行文件',
                    filters: [
                        { name: '可执行文件', extensions: ['exe'] }
                    ],
                    properties: ['openFile']
                }).then(result => {
                    if (result.filePaths && result.filePaths.length > 0) {
                        fivemPathInput.value = result.filePaths[0];
                    }
                }).catch(err => console.log('文件选择取消', err));
            } else {
                alert('文件浏览功能仅在桌面应用中可用');
            }
        });
        
        // 保存路径配置
        savePathButton.addEventListener('click', () => {
            const path = fivemPathInput.value.trim();
            if (path) {
                localStorage.setItem('fivemPath', path);
                pathConfig.classList.add('hidden');
                alert('路径配置已保存，下次将直接通过路径启动FiveM');
            } else {
                alert('请输入有效的FiveM路径');
            }
        });
        
        // 取消路径配置
        cancelPathButton.addEventListener('click', () => {
            pathConfig.classList.add('hidden');
        });
        
        // 错误处理函数
        function handleLaunchError(error, message) {
            console.error(`启动错误: ${message}`, error);
            joinButton.disabled = false;
            joinButton.innerHTML = '<i class="fa fa-play-circle mr-3"></i>加入服务器';
            
            let alertMsg = '启动FiveM失败，请确认：\n1. FiveM已安装';
            if (isPakeApp) {
                alertMsg += '\n2. 您可以尝试配置FiveM可执行文件路径以避免协议确认';
                if (!isProtocolConfirmed) {
                    alertMsg += '\n3. 首次启动可能需要在系统提示中选择"始终允许"';
                }
            } else {
                alertMsg += '\n2. 您正在使用桌面应用版本（而非浏览器）';
            }
            alert(alertMsg);
        }

        // 取消启动
        cancelLaunch.addEventListener('click', () => {
            protocolPrompt.classList.add('hidden');
        });

        // 环境检测提示
        window.addEventListener('load', () => {
            console.log(`运行环境: ${isPakeApp ? 'PakePlus桌面应用' : '普通浏览器'}`);
            if (isPakeApp) {
                console.log('提示: 此应用通过PakePlus封装，支持原生协议启动');
                if (fivemPath) {
                    console.log('提示: 已配置FiveM路径，将通过路径直接启动');
                }
            }
        });
    </script>
</body>
</html>